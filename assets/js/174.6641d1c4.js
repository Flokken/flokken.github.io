(window.webpackJsonp=window.webpackJsonp||[]).push([[174],{504:function(a,s,t){"use strict";t.r(s);var n=t(4),e=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h2",{attrs:{id:"nacos配置管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nacos配置管理"}},[a._v("#")]),a._v(" Nacos配置管理")]),a._v(" "),s("h3",{attrs:{id:"nacos管理配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nacos管理配置"}},[a._v("#")]),a._v(" nacos管理配置")]),a._v(" "),s("p",[a._v("将配置交给Nacos管理的步骤")]),a._v(" "),s("ul",[s("li",[a._v("在Nacos中添加配置文件在微服务中引入nacos的config依赖")]),a._v(" "),s("li",[a._v("在微服务中添加bootstrap.yml，")]),a._v(" "),s("li",[a._v("配置nacos地址、当前环境、服务名称、文件后缀名。这些决定了程序启动时去nacos读取哪个文件")])]),a._v(" "),s("img",{staticStyle:{zoom:"70%"},attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619103036166.png"}}),a._v(" "),s("h5",{attrs:{id:""}},[s("a",{staticClass:"header-anchor",attrs:{href:"#"}},[a._v("#")])]),a._v(" "),s("p",[a._v("对于每个服务的配置信息都要两步（"),s("strong",[a._v("对于有热更新需求的服务")]),a._v("），首先在nacos上配置信息（把配置交给nacos处理），然后还要去application.yml中配置相关信息")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619103233777.png",alt:"image-20230619103233777"}})]),a._v(" "),s("p",[a._v("填写各个服务的配置")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619103250256.png",alt:"image-20230619103250256"}})]),a._v(" "),s("p",[a._v("项目获取配置文件的流程（如果把"),s("strong",[a._v("配置信息放在nacos")]),a._v("后项目启动流程）")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619103949075.png",alt:"image-20230619103949075"}})]),a._v(" "),s("p",[s("strong",[a._v("bootstrap是引导文件，引导项目去哪儿读服务的配置")])]),a._v(" "),s("p",[a._v("这里，如果nacos中有配置文件了，本地没有application.yml也可以")]),a._v(" "),s("p",[a._v("以userservice为例")]),a._v(" "),s("p",[a._v("在pom中引入nacos配置依赖")]),a._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("\x3c!--nacos的配置管理依赖--\x3e")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("com.alibaba.cloud"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("spring-cloud-starter-alibaba-nacos-config"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[a._v("然后去在application同一目录增加引导文件"),s("code",[a._v("bootstrap.yml")]),a._v("文件这个文件优先级高于application.yml")]),a._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("application")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" userservice\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("profiles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("active")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dev "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 环境")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cloud")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("nacos")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("server-addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" nacos"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("8848")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# nacos地址")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("file-extension")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" yaml "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 文件后缀名")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br")])]),s("h3",{attrs:{id:"配置自动刷新-热更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置自动刷新-热更新"}},[a._v("#")]),a._v(" 配置自动刷新（热更新）")]),a._v(" "),s("p",[a._v("上面可以做到从nacos读取配置了，但是还需要添加注解才能实现配置的热更新。")]),a._v(" "),s("p",[s("strong",[a._v("根据属性注入方式的不同有两种方式")])]),a._v(" "),s("p",[a._v("假设我们在nacos中的配置是")]),a._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("pattern")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dateformat")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" yyyy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("MM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("dd HH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("MM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("SS\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("方式一：在@Value注入的变量所在类上添加注解@RefreshScope")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619105257192.png",alt:"image-20230619105257192"}})]),a._v(" "),s("p",[a._v("方式二：使用@ConfigurationProperties注解(如果本来就用了这个注解读取属性，啥也不用干)")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619105303548.png",alt:"image-20230619105303548"}})]),a._v(" "),s("blockquote",[s("p",[a._v("自动刷新注意事项：不是所有的配置都适合放到配置中心，"),s("strong",[a._v("维护起来比较麻烦建议将一些关键参数，需要运行时调整的参数放到nacos配置中心，一般都是自定义配置")])])]),a._v(" "),s("h3",{attrs:{id:"多环境共享配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#多环境共享配置"}},[a._v("#")]),a._v(" 多环境共享配置")]),a._v(" "),s("p",[a._v("多环境指的是一个服务，有dev，有product等等场景，就叫多环境，")]),a._v(" "),s("p",[a._v("此时，他的配置文件可能叫"),s("code",[a._v("userservice-dev.yaml")]),a._v(","),s("code",[a._v("uservice-pro.yaml")]),a._v("等等")]),a._v(" "),s("p",[a._v("微服务启动时会从nacos读取多个配置文件：")]),a._v(" "),s("p",[a._v("[spring.application.name]-[spring.profiles.active].yaml，例如：userservice-dev.yaml")]),a._v(" "),s("blockquote",[s("p",[a._v("等同于name-profile.yaml")])]),a._v(" "),s("p",[a._v("[spring.application.name].yaml，例如：userservice.yaml")]),a._v(" "),s("p",[a._v("无论profile如何变化，[spring.application.name].yaml"),s("strong",[a._v("这个文件一定会加载，因此多环境共享配置可以写入这个文件")])]),a._v(" "),s("blockquote",[s("p",[a._v("也就是name.yaml这个文件一定会被加载，所以多环境共享的配置了可以加到这里面")])]),a._v(" "),s("p",[a._v("仍然以之前的例子，假设在"),s("code",[a._v("userservice.yaml")]),a._v("这个文件里写了共享配置，")]),a._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("pattern")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dateformat")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" yyyy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("MM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("dd HH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("MM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("SS\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("envShare")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"值"')]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("那么上面的共享配置信息都能被每个服务读到")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619111827710.png",alt:"image-20230619111827710"}})]),a._v(" "),s("h4",{attrs:{id:"优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#优先级"}},[a._v("#")]),a._v(" 优先级")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20230619111957627.png",alt:"image-20230619111957627"}})]),a._v(" "),s("h4",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("微服务会从nacos读取的配置文件：")]),a._v(" "),s("ul",[s("li",[a._v("[服务名]-[spring.profile.active].yaml，环境配置")]),a._v(" "),s("li",[a._v("[服务名].yaml，默认配置，")])]),a._v(" "),s("p",[a._v("多环境共享优先级：[服务名]-[环境].yaml >[服务名].yaml > 本地配置")])])}),[],!1,null,null,null);s.default=e.exports}}]);