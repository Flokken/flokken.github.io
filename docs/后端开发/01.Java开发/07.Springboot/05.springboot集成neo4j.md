---
title: spring集成neo4j
date: 2023-06-06
tags: 
  - Java
categories: 
  - 后端开发
  - Java开发
  - Springboot
---

> 参考：
>
> https://spring.io/projects/spring-data-neo4j
>
> https://neo4j.com/
>
> [cyber文档](https://neo4j.com/docs/cypher-manual/current/clauses/)

## 安装配置

首先是运行neo4j

~~~dockerfile
docker run -d -p 7474:7474 -p 7687:7687  \
-v /usr/local/neo4j/data:/data \
-v /usr/local/neo4j/logs:/logs \
-v /usr/local/neo4j/conf:/var/lib/neo4j/conf \
-v /usr/local/neo4j/import:/var/lib/neo4j/import \
--name sbom-neo4j neo4j:latest
~~~

注意

这里把容器内的一些目录挂载到主机，可以方便查看和修改，顺便还命名了neo4j

必须保证主机目录存在，不然启动失败

注意name顺序，**并且镜像要带版本**

`docker run --name <container_name> <image_name>`



maven引入依赖

~~~xml
<dependency>
    <groupId>org.neo4j.driver</groupId>
    <artifactId>neo4j-java-driver-spring-boot-starter</artifactId>
</dependency>
~~~

> 参考https://blog.csdn.net/ccnice99/article/details/123420884，说官方要替代上面这个包，发现好像烂尾了，而spring boot的反而一直还在维护
>
> ~~~xml
> <dependency>
>     <groupId>org.neo4j.driver</groupId>
>     <artifactId>neo4j-java-driver-spring-boot-starter</artifactId>
> </dependency>
> ~~~
>
> 但是neo4j的这个包都停止维护了，因此还是用spring-data-neo4j吧

neo4j自带了movie图谱，因此以该图谱为例，展示spring boot集成neo4j的操作

> [spring-neo4文档](https://docs.spring.io/spring-data/neo4j/docs/current/reference/html/)

## 利用spring-data-neo4j操作neo4j

> https://spring.io/guides/gs/accessing-neo4j-data-rest/
>
> https://spring.io/guides/gs/accessing-data-neo4j/

首先开启neo4jRepository注解，，这里除了配置类开启，也可以在application上加@EnableNeo4jRepositories开启（好像，但不能同时这么干，会冲突）

~~~java
@Configuration
@EnableNeo4jRepositories(basePackages = "com.inet.repository")
@EnableTransactionManagement
public class Neo4jConfig {

    @Value("${spring.neo4j.uri}")
    private String url;

    @Value("${spring.neo4j.authentication.username}")
    private String username;

    @Value("${spring.neo4j.authentication.password}")
    private String password;

    @Bean(name = "session")
    public Session neo4jSession() {
        Driver driver = GraphDatabase.driver(url, AuthTokens.basic(username, password));
        return driver.session();
    }

}
~~~

neo4j提供了节点注解@Node,和关系注解@RelationShip,

分别对应neo4j的节点和关系，那么如何通过程序创建实体和关系呢？

~~~java
@Node("Cloud")
public class Cloud {

    @Id
    private String cloudName;

    @Relationship(type = "hasCategory")
    private List<Category>CategoryList;

    public Cloud(String cloudName) {
        this.cloudName = cloudName;
    }
}

~~~

答案是直接赋值，比如上面的cloud，，先new一个，然后save，就有一个cloud节点了，但是注意，要有边的话，要把边的`List<Category>`复制了才有边。也就是说，只要赋值了再save，neo4j中就会创建相应的边。

@Repository注解,以cloud为例，Neo4jRepository已经封装了基础的CURD操作，因此继承其即可，对于一些其他的操作，可以自定义方法再去实现。其中有一些命名规范，如果符合命名规范不用写查询语句，比如`findByCloudName`。

~~~java
@Repository
public interface CloudRepository extends Neo4jRepository<Cloud,String> {

    //符合命名约定的就不用写自定义语句
    Cloud findByCloudName(String name);

    @Query("MATCH (cloud:Cloud)-[:hasProduct]->(product:Product) WHERE cloudName(cloud) = $cloudName RETURN product")
    List<Product>findAllProduct(String cloudName);
}

~~~

## cyber

删除所有数据

~~~cypher
MATCH (n)
DETACH DELETE n
~~~

