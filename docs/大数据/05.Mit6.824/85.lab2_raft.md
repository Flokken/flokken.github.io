---
title: lab2-raft
date: 2023-11-16
tags: 
  - null
categories: 
  - 大数据
  - Mit6.824
---

> 参考：
>
> 课程中的包括架构和锁的建议： [locking](http://nil.csail.mit.edu/6.824/2022/labs/raft-locking.txt) and [structure](http://nil.csail.mit.edu/6.824/2022/labs/raft-structure.txt) 
>
> GO race竞争检测的介绍[`-race` flag](https://go.dev/blog/race-detector).
>
> [Raft论文 (Extended Version)](http://nil.csail.mit.edu/6.824/2022/papers/raft-extended.pdf)
>
> [MIT 6.824 分布式系统](https://www.zhihu.com/column/c_1294335950039019520)

Mit的课程的确非常硬核，并且有很多细节值得思考和学习，很后悔没有早点去学习mit的课程，不然我不会这么垃圾

## 准备工作

**学习或者复习一下`Raft`**

1. **[官网简单介绍](https://link.zhihu.com/?target=https%3A//raft.github.io/)**，只需要看到`Raft Visualization`标题之前。
2. **[一个很棒的可视化](https://link.zhihu.com/?target=http%3A//thesecretlivesofdata.com/raft/)**，慢慢把所有动画放完。
3. **[Raft论文 (Extended Version)](http://nil.csail.mit.edu/6.824/2022/papers/raft-extended.pdf)**主要看`Figure 2`和`Section 5`。
4. **[6.824助教写的注意事项,也可以看成是实验指南](https://link.zhihu.com/?target=https%3A//thesquareplanet.com/blog/students-guide-to-raft/)**

**看看[lab2页面](http://nil.csail.mit.edu/6.824/2022/labs/lab-raft.html)的任务指引**

- `task description`
- `skeleton code`在`src/raft/raft.go`,src/raft下的其它文件都是为**测试**服务的，测试主要流程在test_test.go。

## Part-2A

`Lab 2A`要求我们实现`leader election`。

- 主要编程指引在**[Raft论文](https://link.zhihu.com/?target=https%3A//pdos.csail.mit.edu/6.824/papers/raft-extended.pdf)**的`Figure 2`中，必须按照它的逻辑严格执行，不要自己乱写

经验：

- 请理解清楚raft再开始写，要定义什么方法，方法的逻辑是什么样的，都要想清楚

- 有一些和**等待**有关的参数需要小心选取。

- 我们调试是通过打印来调试的，具体参考[Debugging by Pretty Printing](https://blog.josejg.com/debugging-pretty/)

Raft数据结构

```go
type Raft struct {
	mu        sync.Mutex          // Lock to protect shared access to this peer's state
	peers     []*labrpc.ClientEnd // RPC end points of all peers
	persister *Persister          // Object to hold this peer's persisted state
	me        int                 // this peer's index into peers[]
	dead      int32               // set by Kill()

	state State
	//volatile state all server
	commitIndex int
	lastApplied int
	//volatile state on leader
	nextIndex[]
	matchIndex[]

}
```

需要持久化存储的State

```go
//每个节点需要持久化存储的信息
type State struct{
	currentTerm int
	votedFor int
	log []logEntry
	// //顺便记录一下当前日志的最后一条目录的索引
	// lastLogIndex int
}
```



### election time

### 分裂选举



## Part-2B



## Part-2C



## Part-2D