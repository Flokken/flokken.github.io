---
title: C1 分布式系统模型
date: 2023-05-22
tags: 
  - 深入理解分布式系统
categories: 
  - 大数据
  - 深入理解分布式系统
---

根据系统网络，硬件的不同，分布式系统可能有上百种架构。分析这么多架构显然不太现实，因此应当抽象出一些通用的系统模型，如果一个解决方案在一种模型下正确，则认为他可以处理这种模型的一系列问题，这样就不用重复设计每一个系统。

## 思想实验

### 两将军问题

>https://zh.wikipedia.org/wiki/%E4%B8%A4%E5%86%9B%E9%97%AE%E9%A2%98

#### 问题描述

两支军队由不同将军领导，准备进攻一座坚固的城市。军队在城市附近的两个山谷扎营。由于有另一个山谷将两山隔开，两名将军只能透过派信使穿越山谷通信，但这山谷由城市护卫占领，有可能俘虏途径山谷传递消息的任何信使。

虽然两军已约定要同时进攻，但尚未约定进攻时间。要顺利攻击，两军必须同时进攻。如果同一时间仅一支军队进攻就会战败，**因此两名将军须约定攻击时间，并确保对方知道自己同意了进攻计划**。但由于传递**确认消息的**信使与传递**原始消息**的信使一样，**都可能被俘虏**而丢失消息，即使双方不断确认已收到对方的上一条消息，也无法确保已与对方**达成共识**。

![](https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/2-generals.svg/1920px-2-generals.svg.png)

这个问题被证实理论上无解。

比如将军 A1 给将军 A2 送信说明天进攻。这样，信使出发后，A1 是没有办法去确认信使是不是真的把信送到了的。这样 A1 就会选择不进攻，因为他怕到时候进攻的只有他自己。要让事情确定一些，A2 需要收到信之后给 A1 一个确认信息，说“我已经收到了你给我的要明天进攻的信息了”。信使在给 A1 送信路上也可能会被抓，这样， A2 会倾向于不进攻，因为他知道 A1 如果收不到他的确认信息是不会发动进攻的。**这样推下去，将军始终无法保证信是否送到了对面的将军那里，也就是两个将军始终不能达成共识。**

#### 启示

这个思想实验表明，在一个分布式系统中，一个节点没有办法确认另一个节点的状态的，一**个节点想要知道某个节点的状态的唯一办法是通过发送信息来进行交流尽量得知对方的状态。**

> 工程上的解
>
> 例如TCP的三次握手，思路是接受这种不确定性，但可以尽可能的降低不确定性。因此TCP 是不完全可靠的协议，互联网是一个不完全可靠的网络。

### 拜占庭将军

#### 问题描述

[拜占庭](https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Byzantine_Empire)军队的几个师驻扎在敌城外, 每个师都由各自的将军指挥. 将军们只能通过信使相互沟通. 在观察敌情之后, 他们必须制定一个共同的行动计划, 如**进攻(Attack)**或者**撤退(Retreat)**, 且只有当半数以上的将军共同发起进攻时才能取得胜利. 然而, 其中一些将军可能是叛徒, 试图阻止忠诚的将军达成一致的行动计划. 更糟糕的是, 负责消息传递的信使也可能是叛徒, 他们可能篡改或伪造消息, 也可能使得消息丢失.

>详细分析见
>
>https://zhuanlan.zhihu.com/p/107439021

#### 启示

,拜占庭将军问题中的角色与计算机世界的对应关系如下:

- 将军, 对应计算机节点;
- 忠诚的将军, 对应运行良好的计算机节点;
- 叛变的将军, 被非法控制的计算机节点;
- 信使被杀, 通信故障使得消息丢失;
- 信使被间谍替换, 通信被攻击, 攻击者篡改或伪造信息.

如上文所述, 拜占庭将军问题提供了对**分布式共识问题**的一种情景化描述, 是分布式系统领域最复杂的模型. 此外, 它也为我们理解和分类现有的众多分布式一致性协议和算法提供了框架. 现有的分布式一致性协议和算法主要可分为两类:

- 一类是**故障容错算法(Crash Fault Tolerance, CFT)**, 即非拜占庭容错算法, 解决的是分布式系统中存在故障, 但不存在恶意攻击的场景下的共识问题. 也就是说, 在该场景下可能存在消息丢失, 消息重复, 但不存在消息被篡改或伪造的场景. 一般用于局域网场景下的分布式系统, 如分布式数据库. 属于此类的常见算法有Paxos算法, Raft算法, ZAB协议等.
- 一类是**拜占庭容错算法**, 可以解决分布式系统中既存在故障, 又存在恶意攻击场景下的共识问题. 一般用于互联网场景下的分布式系统, 如在数字货币的区块链技术中. 属于此类的常见算法有PBFT算法, PoW算法.

## 系统模型

从上面的思想实验中，我们知道，分布式系统中的节点和网络都可能出现故障（**将军和信使**），我们的系**统模型就是根据不同种类的故障抽象出来。**设计一个分布式系统时，需要知道系统会发生什么类型故障，然后寻找对应的解。

按照网络，节点故障和时间可以如下划分。

#### 网络链路模型

网络链路是不可靠的，有一些错误无法避免，比如管理员插错网卡，或者挖掘机挖断光纤

网络出错导致的问题称为网络分区（**Network Partition**），网络分区指的是由于网络设备故障，导致网络裂变为多个独立的组。也即是节点仍然正常工作，但他们之间的通信连接已经中断。

> 讨论该问题时，默认网络中断会存在一段时间

为了简化问题，可以忽略人或者挖掘机这些细节。大多数分布式算法都假设网络是点对点的单播通信，消息通常在两个节点之间相互传递。

##### 假设

我们假设有一个发送者和一个接受者，他们通过一个双向的链路通信。一个链路有两个最基本的事件：发送事件，也就是将一套消息发送到链路上；接收事件，链路返回一条消息。

按照如上假设，可以对发送者和接收者通信网络链路分为：

**可靠链路（Reliable Link）、公平损失链路（Fair-Loss Link）、任意链路（Arbitrary Link）**

##### 可靠链路

也称为完美链路（Perfect Link），既不会丢失消息，也不会凭空捏造消息，但有可能对消息重新排序。特点如下：

（1）可靠传递：如果进程p和q都正常工作，则进程p发送到进程q的每个消息都会被链路传递

（2） 没有重复：每条消息最多传递一次

（3）不会无中生有：链路不会自己生成消息，也就是不会发送一个从来没有发送过的消息

比如TCP就是一个可靠链路（但是TCP保证比上面还多），但**注意可靠链路没有保证消息有序**

##### 公平损失链路

公平损失链路的消息可能丢失、重复或重新排序，但消息最终总会到到达。

特点：

（1） 公平损失：如果发送方和接收方都是正常运行，且发送方不断重复发送消息，则消息最终会被送到

​			**也就是任何网络中断只会持续有限时间，不会永远持续，所以最终可以送到**

（2） 有限重复：消息只会重复发送有限次

（3）不会无中生有：链路不会自己生成消息，也就是不会发送一个从来没有发送过的消息

##### 任意链路

任意链路是最弱的一种网络链路模型。**允许任何网络链路执行任何操作**，可能有恶意软件修改网卡了。比如公共wifi不可信，其所有者可能监听，甚至修改数据包。**这也是最接近互联网的模型。**

##### 总结

这三种模型可以互相转换。比如对公平链路，可以不断重传丢失的消息，直到接受者收到他们，并让接受者过滤重复消息，这样就变成了可靠链路。

#### 节点故障类型

节点再回复消息时可能出现故障，比如消息的发送者试图重传消息时宕机，从而导致可消息永久丢失，这引出了节点故障。

故障类型喝多，可以分为三中卡类型

#### 按时间划分系统模型

