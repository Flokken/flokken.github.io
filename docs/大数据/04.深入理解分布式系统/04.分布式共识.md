---
title: 分布式共识
date: 2023-10-15
tags: 
  - 深入理解分布式系统
categories: 
  - 大数据
  - 深入理解分布式系统
---

> 这里内容主要摘录自《深入理解分布式系统》一书，并且只记录了个人认为最核心的部分

## 概念介绍

**什么是分布式共识 ？**

分布式共识指的是分布式系统中的节点面对一些情况（比如leader选举，日志分歧）时如何达成共识的过程与方法。

> 比如raft，paxos算法也就是一种共识。

**为什么需要共识？**

我们知道分布式系统中存在着网络分区，节点故障和时钟不一致等问题。

那么我们有什么解决办法呢？在分布式系统领域，**状态机复制**（State Machine Replication ,SMR）是用于解决上面问题的常规方法。

> 状态机复制也称为**复制状态机**（Replicated State Machine），或者**多副本状态机**，常常混用这些称呼

**状态机：**包括一组状态，一组输入，一组输出，一个转换函数，一个输出函数和一个“初始”状态。

**状态机最重要的是状态机具有确定性：**多个相同的状态机的副本，从同样的初始状态开始，经过相同的输入序列，会到达相同状态，输出同样结果。

可以定义状态机伪码：

~~~
//初始状态
state = init
log =[]
while true:
#客户输入,cmd就是输入
	on receiving cmd from a client:
		log.append(cmd)
		#生成新的状态和输出
		state,output = apply(cmd,state)
		send output to the client
~~~

**正是由于状态机的确定性，我们可以通过它来实现分布式系统中节点的一致性。**

> 状态机复制是理论上的东西，对应系统中其实就是多副本日志

具体来说：我们的分布式系统中，每个节点都有复制状态机，这些复制状态就对于相同的输入，产生相同的输出，到达一致的状态

**实现状态机复制常常需要实现一个多副本的日志（Replicated log）系统，**原因来自于工程经验：

- 如果日志的内容和顺序都相同，多个进程从同一状态开始，并且从相同的顺序读取日志，那么这些进程产生相同的输出，并且结束在相同的状态。

**共识算法常用来实现多副本日志。**

共识算法使得分布式系统中的每个副本（就是每个节点的日志副本），对日志的值和顺序达成共识，**也就是说每个节点存储相同的日志副本**，这样整个系统中的每个节点都能有一致的状态和输出。

> 这样这个分布式系统对外部来说就是一个单独的，高可用的状态机。

### 共识算法能解决的问题

之后会学习的raft以及paxos等算法，**除了可以解决一开始提到的：网络分区，时钟不一致，节点故障等问题。**

还可以解决一些经典问题：

- 互斥（Mutual Exclusion）：分布式系统中的进程到临界区访问资源，怎么保证访问顺序以及进程安全？其实就是分布式锁？
- 选主（Leader Election）：在单主复制的数据库系统中，如果master出现故障，那么剩下的节点就需要选一个新的master，那么如何让所有的节点在master节点选举上达成共识？
- 原子提交（Atomic Commit）:对于跨多节点或者多分区事务的数据库，一个事务可能在一些节点上成功，一些节点上失败。如果我们需要维护这种分布式事务的一致性，必须让所有节点对事务的结果达成共识：要么全部提交，要么全部中止。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           

### 异步系统中的共识

分布式系统可以分为同步，异步和部分同步系统，其中异步系统更接近现实

>复习一下
>
>基于时间或者是否同步（Synchronous),可以将系统分为同步系统模型和异步模型（Asynchronous）。
>
>同步系统模型（Synchronous）：一个消息的响应时间在有限且已知的范围内
>
>异步（Asyncchronous）系统模型指的是，一个消息的响应时间是无限的，无法知道一条消息什么时候到达。

**FPL不可能定理**

1985年的一篇论文证明了，一个完全异步的分布式系统中，即使只有一个系统出现故障，也不存在一个算法能达成共识。**这是一个经典结论。**

> 简单来说，在一个异步系统中，进程可以在任意时间返回响应，因此我们无法分辨一个节点是已经崩溃还是速度很慢。这导致我们无法在有限时间内达成共识

从这个定理出发，研究人员发现一个分布式共识算法应该具有两个属性：

- 安全性：所有正确的进程最终认同同一个值
- 活性：分布式系统最终会认同同一个值

FTP应该这么理解：在一个完全异步的系统中，不能同时得到容错性，安全性和活性（但可以同时得到其中两个）

理论上FTP定理虽然误解，但是工程上有解，可以绕过FTP定理。

> 主要是思路是异步系统不能达成共识，那就想办法把他变成同步的

- 故障屏蔽：如果一个进程（节点）有故障，那么他最终是会恢复的（人为或自动），并且会重新加入分布式系统。常见的一种方式是一个进程崩溃，那么他会重启，并且在故障之前；他已经持久化了足够的信息，那么其奔溃后重启也可以再正常工作。（已经广泛应用于各种系统）
- 使用故障检测器：进程可以通过某种检测器检测其是否故障。比如常见的实现是超时故障检测器，一个进程在一段时间内没有响应，就认为他已经故障了。

### 同步系统中共识