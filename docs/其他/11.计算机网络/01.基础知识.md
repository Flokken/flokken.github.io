---
title: 即网基础知识
date: 2024-03-05
tags: 
  - 设计模式
categories: 
  - 其他
  - 设计模式
---

## TCP/IP 网络模型

$Question：$网络模型有什么用?
$Answer:$对于同一台设备上的进程间通信，有很多种方式，比如有管道、消息队列、共享内存、信号等方式，而对于不同设备上的进程间通信，就需要网络通信，**而设备是多样性的，所以要兼容多种多样的设备**，就协商出了一套**通用的网络协议**。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/tcpip%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B.drawio.png" alt="img" style="zoom:80%;" />

### 应用层

最上层的，我们能直接接触到的就是**应用层**（*Application Layer*），我们电脑或手机使用的应用软件都是在应用层实现。

不过，当两个不同设备的应用需要通信的时候，应用就把应用数据传给下一层，也就是传输层。

应用层只需要专注于为用户提供应用功能，**比如 HTTP、FTP、Telnet、DNS、SMTP等。**

应用层是不用去关心数据是如何传输的，就类似于，我们寄快递的时候，只需要把包裹交给快递员，由他负责运输快递，我们不需要关心快递是如何被运输的。

而且**应用层是工作在操作系统中的用户态，传输层及以下则工作在内核态。**

### 传输层

应用层的数据包会传给传输层，**传输层**（*Transport Layer*）是为应用层**提供网络支持**的。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/%E5%BA%94%E7%94%A8%E5%B1%82.png" alt="img" style="zoom:67%;" />

在传输层会有两个传输协议，分别是 TCP 和 UDP。

TCP 的全称叫传输控制协议（*Transmission Control Protocol*），大部分应用使用的正是 TCP 传输层协议，比如 HTTP 应用层协议。TCP 相比 UDP 多了很多特性，比如流量控制、超时重传、拥塞控制等，这些都是为了保证数据包能可靠地传输给对方。

UDP 相对来说就很简单，简单到只负责发送数据包，不保证数据包是否能抵达对方，但它实时性相对更好，传输效率也高。当然，UDP 也可以实现可靠传输，把 TCP 的特性在应用层上实现就可以，不过要实现一个商用的可靠 UDP 传输协议，也不是一件简单的事情。

应用需要传输的数据可能会非常大，如果直接传输就不好控制，因此当传输层的**数据包大小超过 MSS**（TCP 最大报文段长度） ，就要将数据包**分块，**这样即使中途有一个分块丢失或损坏了，只需要重新发送这一个分块，而不用重新发送整个数据包。在 TCP 协议中，我们把每个分块称为一个 **TCP 段**（*TCP Segment*）。

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305212203246.png" alt="image-20240305212203246" style="zoom:67%;" />

**端口**:当设备作为接收方时，传输层则要负责把数据包传给应用，但是一台设备上可能会有很多应用在接收或者传输数据，因此需要用一个编号将应用区分开来，这个编号就是**端口**。

> 80 端口通常是 Web 服务器用的，22 端口通常是远程登录服务器用的
>
> 而对于浏览器（客户端）中的**每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时的端口号**。

由于传输层的报文中会携带端口号，因此接收方可以识别出该报文是发送给哪个应用

### 网络层

$Question：$应用层的数据包有传输层负责，那么它负责将数据从一个设备传输到另一个设备吗?

Answer: **并不是**

实际场景中的网络环节是错综复杂的，中间有各种各样的线路和分叉路口，如果一个设备的数据要传输给另一个设备，就需要在各种各样的路径和节点进行选择，而传输层的设计理念是简单、高效、专注，如果传输层还负责这一块功能就有点违背设计原则了。

也就是说，我们不希望传输层协议处理太多的事情，只需要服务好应用即可，让其作为应用间数据传输的媒介，帮助实现应用到应用的通信，**而实际的传输功能就交给下一层**，也就是**网络层**（*Internet Layer*）

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305212536498.png" alt="image-20240305212536498" style="zoom:67%;" />

#### IP

网络层最常使用的是 IP 协议（*Internet Protocol*），IP 协议会将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文，如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会**再次进行分片**，得到一个即将发送到网络的 IP 报文。

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305214218179.png" alt="image-20240305214218179" style="zoom:67%;" />

IP地址的作用:网络层负责将数据从一个设备传输到另一个设备，而IP就是区分这个设备的编号

对于IPV4协议，32位，也有上忆的ip，寻址时依然麻烦。

所以IP地址两种意义:

- 一个是**网络号**，负责标识该 IP 地址是属于哪个「子网」的；
  - IP地址与子网掩码做与运算得到
- 一个是**主机号**，负责标识同一「子网」下的不同主机；
  - IP地址与取反的子网掩码做与运算得到

**寻址过程是先找同一子网，再去子网下找这个主机**

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305214938627.png" alt="image-20240305214938627" style="zoom:67%;" />

**子网掩码的简洁表示:**

比如 10.100.122.0/24，后面的`/24`表示就是 `255.255.255.0` 子网掩码,因为每段8位，有24个1，所以是`/24`

#### 路由

除了寻址能力， IP 协议还有另一个重要的能力就是**路由**

实际场景中，两台设备并不是用一条网线连接起来的，而是通过很多网关、路由器、交换机等众多网络设备连接起来的，那么就会形成很多条网络的路径，因此当数据包到达一个网络节点，就需要通过路由算法决定下一步走哪条路径

路由器寻址工作中，就是要找到**目标地址的子网**，找到后进而把数据包转发给对应的网络内。

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305215228696.png" alt="image-20240305215228696" style="zoom:67%;" />

所以，**IP 协议的寻址作用是告诉我们去往下一个目的地该朝哪个方向走，路由则是根据「下一个目的地」选择路径。寻址更像在导航，路由更像在操作方向盘**。

### 网络接口层

生成了 IP 头部之后，接下来要交给**网络接口层**（*Link Layer*）在 IP 头部的前面加上 **MAC 头部**，并封装成数据帧（Data frame）发送到网络上。

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305215356581.png" alt="image-20240305215356581" style="zoom:67%;" />

IP 头部中的接收方 IP 地址表示网络包的目的地，**通过这个地址我们就可以判断要将包发到哪里**。

但在以太网的世界中，这个思路是行不通的。

什么是以太网呢？电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。**以太网就是一种在「局域网」内，把附近的设备连接起来，使它们之间可以进行通讯的技术**。

以太网在判断网络包目的地时和 IP 的方式不同，因此必须采用相匹配的方式才能在以太网中将包发往目的地（具体哪个设备），而 **MAC 头部就是干这个用的**，所以，在以太网进行通讯要用到 **MAC 地址**。

### 总结

TCP/IP 网络通常是由上到下分成 4 层，分别是**应用层，传输层，网络层和网络接口层**。

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305215821570.png" alt="image-20240305215821570" style="zoom:67%;" />

对于我们从应用层的数据，也是一级级封装下去

其中，网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为**数据包**。

<img src="https://typora-1309665611.cos.ap-nanjing.myqcloud.com/typora/image-20240305215859775.png" alt="image-20240305215859775" style="zoom:67%;" />